#!/bin/bash

# Package management setup for different operating systems

set -e

# Metadata for this component
metadata() {
    echo "ðŸ“¦:Package Management Setup:Install package managers and essential development tools"
}

# Source utility functions
source "$(dirname "${BASH_SOURCE[0]}")/../utils/functions.sh"

OS=$(detect_os)

setup_package_manager() {
    print_status "blue" "Setting up package manager for $OS..."
    
    case $OS in
        "macos")
            setup_homebrew
            ;;
        "linux")
            setup_linux_packages
            ;;
        *)
            print_status "red" "Unsupported operating system: $OS"
            exit 1
            ;;
    esac
}

setup_homebrew() {
    if ! command_exists brew; then
        print_status "blue" "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        
        # Add Homebrew to PATH for Apple Silicon Macs
        if [[ -f "/opt/homebrew/bin/brew" ]]; then
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
        print_status "green" "Homebrew installed successfully"
    else
        print_status "green" "Homebrew already installed"
    fi
}

setup_linux_packages() {
    local distro=$(get_linux_distro)
    print_status "blue" "Detected Linux distribution: $distro"
    
    case $distro in
        "ubuntu"|"debian")
            if command_exists apt-get; then
                print_status "blue" "Updating apt package lists..."
                sudo apt-get update
            fi
            ;;
        *)
            print_status "yellow" "Unknown Linux distribution, proceeding with caution..."
            ;;
    esac
}

install_essential_packages() {
    print_status "blue" "Installing essential packages..."
    
    case $OS in
        "macos")
            install_macos_packages
            ;;
        "linux")
            install_linux_essential_packages
            ;;
    esac
}

install_macos_packages() {
    local packages=(
        "neovim"
        "git"
        "curl"
        "wget"
        "tree"
        "jq"
        "zsh"
        "pinentry-mac"
        "gpg"
        "watch"
        "bat"
        "lsd"
        "dust"
        "duf"
        "broot"
        "atuin"
        "font-fira-code-nerd-font"
        "k9s"
    )
    
    for package in "${packages[@]}"; do
        if ! brew list "$package" &> /dev/null; then
            print_status "blue" "Installing $package..."
            brew install "$package"
            
            # Remove default .zshrc if we just installed zsh, so yadm can manage it
            if [[ "$package" == "zsh" ]] && [[ -f "$HOME/.zshrc" ]]; then
                print_status "blue" "Removing default .zshrc to allow yadm management..."
                rm "$HOME/.zshrc"
            fi
        else
            print_status "green" "$package already installed"
        fi
    done
}

install_linux_essential_packages() {
    local distro=$(get_linux_distro)
    
    case $distro in
        "ubuntu"|"debian")
            install_debian_packages
            ;;
        *)
            print_status "yellow" "Skipping package installation for unknown distribution"
            ;;
    esac
}

install_debian_packages() {
    local packages=(
        "neovim"
        "git"
        "curl"
        "wget"
        "tree"
        "jq"
        "ripgrep"
        "fd-find"
        "build-essential"
        "gpg"
        "zsh"
        "watch"
        "bat"
        "lsd"
        "dust"
        "duf"
        "broot"
    )
    
    for package in "${packages[@]}"; do
        if ! dpkg -l | grep -q "^ii  $package "; then
            print_status "blue" "Installing $package..."
            sudo apt-get install -y "$package"
            
            # Remove default .zshrc if we just installed zsh, so yadm can manage it
            if [[ "$package" == "zsh" ]] && [[ -f "$HOME/.zshrc" ]]; then
                print_status "blue" "Removing default .zshrc to allow yadm management..."
                rm "$HOME/.zshrc"
            fi
        else
            print_status "green" "$package already installed"
        fi
    done
    
    # Install atuin for Linux
    install_atuin_linux
    
    # Install k9s for Linux
    install_k9s_linux
    
    # Install FiraCode Nerd Font for Linux
    install_linux_nerd_font
}

install_atuin_linux() {
    if command_exists atuin; then
        print_status "green" "atuin already installed"
        return 0
    fi
    
    print_status "blue" "Installing atuin..."
    
    # Install atuin using the official installer
    bash <(curl --proto '=https' --tlsv1.2 -sSf https://setup.atuin.sh)
    
    if command_exists atuin; then
        print_status "green" "atuin installed successfully"
    else
        print_status "red" "Failed to install atuin"
    fi
}

install_k9s_linux() {
    if command_exists k9s; then
        print_status "green" "k9s already installed"
        return 0
    fi
    
    print_status "blue" "Installing k9s..."
    
    local install_dir="$HOME/.local/bin"
    mkdir -p "$install_dir"
    
    # Detect architecture
    local arch=$(uname -m)
    case $arch in
        x86_64)
            arch="amd64"
            ;;
        aarch64|arm64)
            arch="arm64"
            ;;
        *)
            print_status "red" "Unsupported architecture: $arch"
            return 1
            ;;
    esac
    
    # Download and install k9s
    local temp_dir=$(mktemp -d)
    cd "$temp_dir"
    
    local k9s_version="v0.32.7"
    local download_url="https://github.com/derailed/k9s/releases/download/${k9s_version}/k9s_Linux_${arch}.tar.gz"
    
    curl -fsSL "$download_url" -o k9s.tar.gz
    
    if [[ $? -eq 0 ]]; then
        tar -xzf k9s.tar.gz k9s
        mv k9s "$install_dir/"
        chmod +x "$install_dir/k9s"
        
        if command_exists k9s; then
            print_status "green" "k9s installed successfully"
        else
            print_status "green" "k9s installed to $install_dir/k9s (add $install_dir to PATH if needed)"
        fi
    else
        print_status "red" "Failed to download k9s"
    fi
    
    # Cleanup
    cd - > /dev/null
    rm -rf "$temp_dir"
}

install_linux_nerd_font() {
    local font_dir="$HOME/.local/share/fonts"
    local font_name="FiraCode Nerd Font"
    
    # Check if font is already installed
    if fc-list | grep -i "fira.*code.*nerd" > /dev/null 2>&1; then
        print_status "green" "FiraCode Nerd Font already installed"
        return 0
    fi
    
    print_status "blue" "Installing FiraCode Nerd Font..."
    
    # Create fonts directory
    mkdir -p "$font_dir"
    
    # Download and install FiraCode Nerd Font
    local temp_dir=$(mktemp -d)
    cd "$temp_dir"
    
    curl -fsSL "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/FiraCode.zip" -o FiraCode.zip
    
    if [[ $? -eq 0 ]]; then
        unzip -q FiraCode.zip -d "$font_dir/"
        
        # Refresh font cache
        fc-cache -fv > /dev/null 2>&1
        
        print_status "green" "FiraCode Nerd Font installed successfully"
    else
        print_status "red" "Failed to download FiraCode Nerd Font"
    fi
    
    # Cleanup
    cd - > /dev/null
    rm -rf "$temp_dir"
}

# Main execution
main() {
    setup_package_manager
    install_essential_packages
    print_status "green" "Package setup completed!"
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi